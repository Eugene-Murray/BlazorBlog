@page "/counter"
@rendermode InteractiveAuto
@using Fluxor
@using BlazorExperiments.Client.Store.Counter
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

<PageTitle>Counter with Fluxor</PageTitle>

<h1>Counter with Fluxor State Management</h1>

<div class="alert alert-warning">
    <strong>Debug Info:</strong><br />
    CounterState is null: @(CounterState == null)<br />
    Dispatcher is null: @(Dispatcher == null)<br />
    @if (CounterState != null)
    {
        <span>CounterState.Value is null: @(CounterState.Value == null)</span><br />
        @if (CounterState.Value != null)
        {
            <span>Current Count from State: @CounterState.Value.Count</span>
        }
    }
</div>

<p role="status">Current count: <strong>@CounterState.Value.Count</strong></p>

@if (CounterState.Value.IsLoading)
{
    <p><em>Loading...</em></p>
}

@if (!string.IsNullOrEmpty(CounterState.Value.LastIncrementedBy))
{
    <p>Last incremented by: <strong>@CounterState.Value.LastIncrementedBy</strong></p>
}

<div class="btn-group" role="group">
    <button class="btn btn-primary" @onclick="IncrementCount">
        <span class="oi oi-plus" aria-hidden="true"></span> Increment
    </button>
    <button class="btn btn-warning" @onclick="DecrementCount">
        <span class="oi oi-minus" aria-hidden="true"></span> Decrement
    </button>
    <button class="btn btn-secondary" @onclick="ResetCount">
        <span class="oi oi-loop-circular" aria-hidden="true"></span> Reset
    </button>
</div>

<hr />

<h3>Async Operations (with Effects)</h3>
<p>Click the button below to simulate an async operation that fetches a random count from a "server".</p>

<button class="btn btn-success" @onclick="IncrementCountAsync" disabled="@CounterState.Value.IsLoading">
    <span class="oi oi-cloud-upload" aria-hidden="true"></span> Increment Async
</button>

<hr />

<h3>Redux DevTools</h3>
<p>
    Open your browser's Redux DevTools extension to see:
</p>
<ul>
    <li>All dispatched actions</li>
    <li>State changes over time</li>
    <li>Time-travel debugging</li>
    <li>Action history</li>
</ul>

<div class="alert alert-info mt-3">
    <h4>Fluxor Features Demonstrated:</h4>
    <ul>
        <li><strong>State:</strong> CounterState with Count, IsLoading, and LastIncrementedBy</li>
        <li><strong>Actions:</strong> IncrementCounterAction, DecrementCounterAction, ResetCounterAction, and async actions</li>
        <li><strong>Reducers:</strong> Pure functions in CounterReducers.cs that handle state changes</li>
        <li><strong>Effects:</strong> CounterEffects.cs handles async operations with simulated API calls</li>
        <li><strong>Middleware:</strong> LoggingMiddleware logs all actions to the console</li>
        <li><strong>Redux DevTools:</strong> Full integration for debugging and time-travel</li>
    </ul>
</div>

@code {
    [Inject]
    private IState<CounterState> CounterState { get; set; } = default!;

    [Inject]
    private IDispatcher Dispatcher { get; set; } = default!;

    [Inject]
    private ILogger<Counter> Logger { get; set; } = default!;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Logger.LogInformation("Counter initialized. Current count: {Count}", CounterState.Value.Count);
    }

    private void IncrementCount()
    {
        Logger.LogInformation("IncrementCount button clicked. Before: {Count}", CounterState.Value.Count);
        Dispatcher.Dispatch(new IncrementCounterAction());
        Logger.LogInformation("Action dispatched. After: {Count}", CounterState.Value.Count);
    }

    private void DecrementCount()
    {
        Logger.LogInformation("DecrementCount button clicked");
        Dispatcher.Dispatch(new DecrementCounterAction());
    }

    private void ResetCount()
    {
        Logger.LogInformation("ResetCount button clicked");
        Dispatcher.Dispatch(new ResetCounterAction());
    }

    private void IncrementCountAsync()
    {
        Logger.LogInformation("IncrementCountAsync button clicked");
        Dispatcher.Dispatch(new IncrementCounterAsyncAction("User"));
    }
}
