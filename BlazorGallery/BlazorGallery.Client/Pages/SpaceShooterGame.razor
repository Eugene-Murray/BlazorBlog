@page "/spaceshootergame"
@rendermode InteractiveWebAssembly
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Space Shooter Game</PageTitle>

<div class="game-container">
    <div class="game-header">
        <h2>🚀 Space Shooter</h2>
        <p class="game-description">Defend the galaxy against waves of alien invaders!</p>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-container">
            <p>⚠️ @_errorMessage</p>
            <button @onclick="RetryLoad">Retry</button>
        </div>
    }
    else if (!_gameInitialized)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading game assets...</p>
        </div>
    }

    <div id="game-canvas" class="game-canvas @(_gameInitialized ? "visible" : "hidden")"></div>

    <div class="game-controls-info">
        <div class="control-group">
            <span class="control-key">↑↓←→</span> or <span class="control-key">WASD</span>
            <span class="control-action">Move Ship</span>
        </div>
        <div class="control-group">
            <span class="control-key">SPACE</span>
            <span class="control-action">Fire</span>
        </div>
        <div class="control-group">
            <span class="control-key">P</span>
            <span class="control-action">Pause</span>
        </div>
    </div>

    <div class="game-tips">
        <h4>💡 Tips</h4>
        <ul>
            <li>Collect power-ups for shields, weapon upgrades, and score multipliers</li>
            <li>Defeat 20 enemies to summon the boss</li>
            <li>Each level increases difficulty and boss health</li>
            <li>Your high score is saved locally</li>
        </ul>
    </div>
</div>

<style>
    .game-container {
        max-width: 850px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .game-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .game-header h2 {
        color: #00aaff;
        font-size: 2.5rem;
        margin-bottom: 5px;
        text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
    }

    .game-description {
        color: #888;
        font-size: 1.1rem;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 600px;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 100%);
        border-radius: 8px;
        color: #00ffff;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #0a0a1a;
        border-top: 4px solid #00ffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid #ff4444;
        border-radius: 8px;
        color: #ff6666;
        margin-bottom: 20px;
    }

    .error-container button {
        margin-top: 10px;
        padding: 10px 20px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .error-container button:hover {
        background: #0088ff;
    }

    .game-canvas {
        width: 800px;
        height: 600px;
        margin: 0 auto;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0, 170, 255, 0.3);
        border: 2px solid #00aaff;
    }

    .game-canvas.hidden {
        display: none;
    }

    .game-canvas.visible {
        display: block;
    }

    .game-controls-info {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .control-key {
        background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
        color: #00ffff;
        padding: 6px 12px;
        border-radius: 6px;
        font-family: 'Consolas', monospace;
        font-weight: bold;
        border: 1px solid #00aaff;
        font-size: 0.9rem;
    }

    .control-action {
        color: #aaa;
        font-size: 0.9rem;
    }

    .game-tips {
        margin-top: 20px;
        padding: 15px 20px;
        background: rgba(0, 50, 100, 0.2);
        border-radius: 8px;
        border-left: 4px solid #ffcc00;
    }

    .game-tips h4 {
        color: #ffcc00;
        margin: 0 0 10px 0;
    }

    .game-tips ul {
        margin: 0;
        padding-left: 20px;
        color: #ccc;
    }

    .game-tips li {
        margin-bottom: 5px;
    }

    @@media (max-width: 850px) {
        .game-canvas {
            width: 100%;
            height: auto;
            aspect-ratio: 4 / 3;
        }

        .game-controls-info {
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
    }
</style>

@code {
    private bool _gameInitialized;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPhaserAndInitGame();
        }
    }

    private async Task RetryLoad()
    {
        _errorMessage = null;
        _gameInitialized = false;
        StateHasChanged();
        await Task.Delay(100);
        await LoadPhaserAndInitGame();
    }

    private async Task LoadPhaserAndInitGame()
    {
        try
        {
            // Load Phaser.js from CDN
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    return new Promise((resolve, reject) => {
                        if (window.Phaser) {
                            resolve();
                            return;
                        }
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js';
                        script.onload = () => resolve();
                        script.onerror = () => reject(new Error('Failed to load Phaser'));
                        document.head.appendChild(script);
                    });
                })()
            ");

            // Wait for Phaser to be available
            var maxAttempts = 100;
            var attempts = 0;
            while (attempts < maxAttempts)
            {
                var loaded = await JSRuntime.InvokeAsync<bool>("eval", "typeof Phaser !== 'undefined'");
                if (loaded) break;
                await Task.Delay(100);
                attempts++;
            }

            if (attempts >= maxAttempts)
            {
                _errorMessage = "Failed to load Phaser framework";
                StateHasChanged();
                return;
            }

            // Load the game script from external JS file
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    return new Promise((resolve, reject) => {
                        if (window.SpaceShooter) {
                            resolve();
                            return;
                        }
                        const script = document.createElement('script');
                        script.src = './js/SpaceShooterGame.js';
                        script.onload = () => resolve();
                        script.onerror = () => reject(new Error('Failed to load SpaceShooterGame.js'));
                        document.head.appendChild(script);
                    });
                })()
            ");

            // Small delay to ensure script is fully parsed
            await Task.Delay(100);

            // Initialize the game
            await JSRuntime.InvokeVoidAsync("SpaceShooter.init", "game-canvas");

            _gameInitialized = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error initializing game: {ex.Message}";
            Console.WriteLine(_errorMessage);
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "if(window.SpaceShooter) SpaceShooter.destroy()");
        }
        catch
        {
            // Ignore disposal errors during navigation
        }
    }
}
